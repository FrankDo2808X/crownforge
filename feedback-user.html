<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrownForge Support | History</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Teko:wght@600&display=swap" rel="stylesheet">
    <style>
        :root { --r-black: #101010; --r-dark: #1f1f1f; --r-yellow: #fcaf17; --r-white: #ffffff; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: var(--r-black); font-family: 'Roboto', sans-serif; color: var(--r-white); }

        nav { height: 60px; background: #000; border-bottom: 2px solid var(--r-yellow); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
        .logo { font-family: 'Teko'; font-size: 1.8rem; color: var(--r-white); text-transform: uppercase; }
        .nav-links a { color: #aaa; text-decoration: none; font-weight: bold; margin-left: 20px; font-size: 0.9rem; text-transform: uppercase; }
        .nav-links a.active { color: var(--r-yellow); }

        .container { max-width: 800px; margin: 50px auto; padding: 20px; }
        h1 { font-family: 'Teko'; font-size: 2.5rem; margin-bottom: 20px; text-transform: uppercase; border-left: 5px solid var(--r-yellow); padding-left: 15px; }

        .ticket-card { background: var(--r-dark); margin-bottom: 20px; border-radius: 4px; border-left: 4px solid #333; overflow: hidden; animation: fadeIn 0.5s ease; }
        .ticket-header { padding: 15px 20px; background: #000; display: flex; justify-content: space-between; align-items: center; }
        .ticket-id { color: #555; font-size: 0.8rem; font-family: monospace; }
        
        .ticket-body { padding: 20px; color: #ccc; line-height: 1.5; }

        /* --- NEW REPLY BOX STYLE --- */
        .dev-reply-box {
            margin-top: 15px;
            background: rgba(252, 175, 23, 0.1); /* Low opacity yellow */
            border: 1px solid var(--r-yellow);
            padding: 15px;
            border-radius: 4px;
        }
        .dev-title { color: var(--r-yellow); font-weight: bold; font-family: 'Teko'; font-size: 1.1rem; margin-bottom: 5px; display: block; }
        .dev-msg { color: #fff; font-size: 0.95rem; }

        /* BADGES */
        .badge { font-family: 'Teko'; font-size: 1.2rem; padding: 2px 10px; border-radius: 2px; text-transform: uppercase; letter-spacing: 1px; }
        .status-pending { background: #333; color: #aaa; border: 1px solid #555; }
        .status-confirmed { background: var(--r-yellow); color: #000; box-shadow: 0 0 10px rgba(252, 175, 23, 0.4); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #loading { text-align: center; color: #555; margin-top: 50px; font-weight: bold; }
    </style>
</head>
<body>

    <nav>
        <div class="logo">CrownForge Support</div>
        <div class="nav-links">
            <a href="support-portal.html">Submit Ticket</a>
            <a href="#" class="active">My Tickets</a>
        </div>
    </nav>

    <div class="container">
        <h1>Case History</h1>
        <div id="loading">Connecting to Database...</div>
        <div id="ticketsList"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

       const firebaseConfig = {
    apiKey: "AIzaSyDNy1J7zVJMLGLsyUxRT1EIaIBruI_p2G8",
    authDomain: "crownforgestudio-2581a.firebaseapp.com",
    projectId: "crownforgestudio-2581a",
    storageBucket: "crownforgestudio-2581a.appspot.com",
    messagingSenderId: "223324386293",
    appId: "1:223324386293:web:783a3e64f0d10b1ab026bc"
  };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, (user) => {
            const listDiv = document.getElementById('ticketsList');
            const loading = document.getElementById('loading');

            if (user) {
                const q = query(collection(db, "usersFeedBacks"), where("uid", "==", user.uid));

                onSnapshot(q, (snapshot) => {
                    loading.style.display = 'none';
                    let tickets = [];
                    snapshot.forEach(doc => tickets.push({ id: doc.id, ...doc.data() }));

                    // Sort: Newest first
                    tickets.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                    listDiv.innerHTML = ""; 

                    if(tickets.length === 0) {
                        listDiv.innerHTML = "<p style='color:#555; text-align:center'>NO RECORDS FOUND.</p>";
                        return;
                    }

                    tickets.forEach((data) => {
                        let statusHTML = '';
                        let borderClass = '';
                        let replyHTML = ''; // Logic for displaying Reply

                        // 1. Check Status
                        if(data.confirmed === true) {
                            statusHTML = `<span class="badge status-confirmed">CONFIRMED / SEEN</span>`;
                            borderClass = `style="border-left: 4px solid var(--r-yellow)"`;
                        } else {
                            statusHTML = `<span class="badge status-pending">PENDING REVIEW</span>`;
                            borderClass = `style="border-left: 4px solid #333"`;
                        }

                        // 2. Check for Admin Reply
                        if(data.adminReply && data.adminReply.trim() !== "") {
                            replyHTML = `
                                <div class="dev-reply-box">
                                    <span class="dev-title">â˜… OFFICIAL DEVELOPER RESPONSE:</span>
                                    <span class="dev-msg">${data.adminReply}</span>
                                </div>
                            `;
                        }

                        // 3. Render
                        const html = `
                            <div class="ticket-card" ${borderClass}>
                                <div class="ticket-header">
                                    <span class="ticket-id">CASE ID: ${data.id.substring(0,8)}...</span>
                                    ${statusHTML}
                                </div>
                                <div class="ticket-body">
                                    <p>"${data.message}"</p>
                                    ${replyHTML}
                                </div>
                            </div>
                        `;
                        listDiv.innerHTML += html;
                    });
                });
            } else {
                window.location.href = "support-portal.html";
            }
        });
    </script>
</body>
</html>
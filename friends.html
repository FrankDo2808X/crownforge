<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CrownForge - Friends & Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:"Poppins",sans-serif;}
body{background: radial-gradient(circle at top,#0f0f1a,#000);color:white;min-height:100vh;padding:20px;}
h1{text-align:center;margin-bottom:20px;font-weight:600;text-shadow:0 0 10px #0ff;}
.panel{max-width:600px;margin:10px auto;background:rgba(255,255,255,0.05);border-radius:15px;padding:20px;backdrop-filter:blur(12px);border:1px solid rgba(0,255,255,0.2);}
.panel h2{text-align:center;margin-bottom:15px;text-shadow:0 0 5px #0ff;}
.search-container{display:flex;justify-content:center;margin-bottom:20px;flex-wrap:wrap;}
.search-container input{width:250px;padding:10px 15px;border-radius:30px;border:1px solid #00ffff;background:rgba(255,255,255,0.05);color:white;outline:none;margin-right:10px;}
.search-container button{padding:10px 20px;border-radius:30px;border:none;background:linear-gradient(90deg,#00ffff,#00aaff);color:black;font-weight:600;cursor:pointer;box-shadow:0 0 10px rgba(0,255,255,0.5);transition:0.3s;}
.search-container button:hover{transform: scale(1.05);box-shadow:0 0 20px #0ff;}
.profile-card{display:flex;flex-direction:column;align-items:center;text-align:center;margin-top:10px;}
.profile-pic{width:100px;height:100px;border-radius:50%;border:2px solid #0ff;object-fit:cover;margin-bottom:10px;}
.profile-name{font-weight:600;font-size:1.2rem;margin-bottom:5px;}
.profile-email{color:#0ff;font-size:0.9rem;margin-bottom:10px;}
.btn{padding:8px 15px;border:none;border-radius:25px;font-weight:600;cursor:pointer;transition:0.3s;margin:5px;}
.add-btn{background:linear-gradient(90deg,#4caf50,#2e7d32);color:white;}
.add-btn:hover{box-shadow:0 0 15px #4caf50;transform:scale(1.05);}
.chat-btn{background:#ff9800;color:black;}
.chat-btn:hover{box-shadow:0 0 15px #ff9800;transform:scale(1.05);}
#reqContainer,.friend-list{display:flex;flex-direction:column;gap:10px;}
.request-card,.friend-card{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:15px;background:rgba(255,255,255,0.05);border:1px solid rgba(0,255,255,0.1);backdrop-filter:blur(8px);}
.request-card img,.friend-card img{width:50px;height:50px;border-radius:50%;border:2px solid #0ff;object-fit:cover;}
.req-info,.friend-info{flex:1;margin-left:10px;}
.req-btns,.friend-btns{display:flex;gap:5px;}
#chatPanel{position:fixed;bottom:0;right:0;width:300px;max-width:90%;height:400px;background:rgba(0,0,0,0.9);border-radius:15px;display:none;flex-direction:column;overflow:hidden;}
#chatHeader{background:linear-gradient(90deg,#00ffff,#00aaff);padding:10px;color:black;font-weight:600;display:flex;justify-content:space-between;align-items:center;cursor:pointer;}
#chatMessages{flex:1;padding:10px;overflow-y:auto;background:rgba(255,255,255,0.05);}
.message{margin-bottom:5px;padding:8px 12px;border-radius:12px;max-width:80%;word-wrap:break-word;}
.message.self{background:#00ffff;color:black;align-self:flex-end;}
.message.other{background:#555;color:white;align-self:flex-start;}
#chatInputContainer{display:flex;border-top:1px solid rgba(0,255,255,0.2);}
#chatInput{flex:1;padding:10px;border:none;outline:none;background:rgba(255,255,255,0.05);color:white;}
#sendBtn{padding:10px;border:none;background:#4caf50;color:white;cursor:pointer;}
@media(max-width:500px){.search-container input{width:70%;margin-bottom:10px;}}
</style>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, getDocs, setDoc, deleteDoc, query, where, addDoc, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDNy1J7zVJMLGLsyUxRT1EIaIBruI_p2G8",
  authDomain: "crownforgestudio-2581a.firebaseapp.com",
  projectId: "crownforgestudio-2581a",
  storageBucket: "crownforgestudio-2581a.appspot.com",
  messagingSenderId: "223324386293",
  appId: "1:223324386293:web:9d7919c6b2e93781b026bc",
  measurementId: "G-FC52FSYPGV"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser, chatWithId;

// Elements
const searchBtn = document.getElementById("searchBtn");
const searchInput = document.getElementById("searchInput");
const profileCard = document.getElementById("profileCard");
const reqContainer = document.getElementById("reqContainer");
const friendListDiv = document.getElementById("friendList");

// Chat Panel
const chatPanel = document.getElementById("chatPanel");
const chatMessages = document.getElementById("chatMessages");
const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");
const chatHeader = document.getElementById("chatHeader");

// Helper to safely get name/photo
function safeName(user) { return user?.name || "Unnamed"; }
function safePhoto(user) { return user?.photoURL || "https://i.imgur.com/GYUx3Um.png"; }

onAuthStateChanged(auth,user=>{
  if(!user) return alert("Login required");
  currentUser=user;
  loadFriendRequests();
  loadFriends();
});

// SEARCH USERS
searchBtn.onclick=async()=>{
  const val=searchInput.value.trim();
  if(!val) return alert("Enter UID or Name!");
  let userData=null, userId="";
  const docSnap = await getDoc(doc(db,"users",val));
  if(docSnap.exists()){userData=docSnap.data(); userId=val;}
  else{
    const q=query(collection(db,"users"),where("name","==",val));
    const snap=await getDocs(q);
    if(!snap.empty){userData=snap.docs[0].data(); userId=snap.docs[0].id;}
  }
  if(!userData) return alert("User not found!");
  profileCard.innerHTML=`
    <img src="${safePhoto(userData)}" class="profile-pic">
    <div class="profile-name">${safeName(userData)}</div>
    <div class="profile-email">${userData.email||'No Email'}</div>
    <button class="btn add-btn" id="addFriendBtn">Add Friend</button>`;
  document.getElementById("addFriendBtn").onclick=async()=>{
    await setDoc(doc(db,"users",userId,"requests",currentUser.uid),{from:currentUser.uid,timestamp:new Date()});
    alert("âœ… Friend Request Sent!");
  };
};

// FRIEND REQUESTS
async function loadFriendRequests(){
  reqContainer.innerHTML="";
  const reqSnap = await getDocs(collection(db,"users",currentUser.uid,"requests"));
  if(reqSnap.empty){reqContainer.innerHTML="<p>No friend requests ðŸ˜Œ</p>"; return;}
  reqSnap.forEach(async r=>{
    const fromUID=r.id;
    const dataSnap=await getDoc(doc(db,"users",fromUID));
    const data=dataSnap.data();
    const card=document.createElement("div");
    card.className="request-card";
    card.innerHTML=`
      <img src="${safePhoto(data)}">
      <div class="req-info">${safeName(data)}</div>
      <div class="req-btns">
        <button class="btn accept" onclick="acceptReq('${fromUID}')">Accept</button>
        <button class="btn decline" onclick="declineReq('${fromUID}')">Decline</button>
      </div>`;
    reqContainer.appendChild(card);
  });
}
window.acceptReq=async(uid)=>{
  await setDoc(doc(db,"users",currentUser.uid,"friends",uid),{accepted:true});
  await setDoc(doc(db,"users",uid,"friends",currentUser.uid),{accepted:true});
  await deleteDoc(doc(db,"users",currentUser.uid,"requests",uid));
  loadFriendRequests();
  loadFriends();
};
window.declineReq=async(uid)=>{
  await deleteDoc(doc(db,"users",currentUser.uid,"requests",uid));
  loadFriendRequests();
};

// FRIENDS LIST
async function loadFriends(){
  friendListDiv.innerHTML="";
  const snap = await getDocs(collection(db,"users",currentUser.uid,"friends"));
  snap.forEach(async f=>{
    const friendSnap = await getDoc(doc(db,"users",f.id));
    const fData=friendSnap.data();
    const card=document.createElement("div");
    card.className="friend-card";
    card.innerHTML=`
      <img src="${safePhoto(fData)}">
      <div class="friend-info">${safeName(fData)}</div>
      <div class="friend-btns">
        <button class="btn chat-btn" onclick="openChat('${f.id}','${safeName(fData)}')">Chat</button>
      </div>`;
    friendListDiv.appendChild(card);
  });
}

// CHAT
function generateChatId(u1,u2){return u1<u2?u1+"_"+u2:u2+"_"+u1;}
window.openChat=(friendId,friendName)=>{
  chatWithId=friendId;
  chatPanel.style.display="flex";
  chatHeader.innerHTML=`Chat with ${friendName} <span style="cursor:pointer;" onclick="chatPanel.style.display='none';chatWithId=null;">âœ–</span>`;
  const msgRef=collection(db,"chats",generateChatId(currentUser.uid,friendId),"messages");
  const msgQuery=query(msgRef,orderBy("timestamp"));
  onSnapshot(msgQuery,snap=>{
    chatMessages.innerHTML="";
    snap.forEach(m=>{
      const data=m.data();
      const div=document.createElement("div");
      div.className="message "+(data.sender===currentUser.uid?"self":"other");
      div.textContent=data.text;
      chatMessages.appendChild(div);
    });
    chatMessages.scrollTop=chatMessages.scrollHeight;
  });
};
sendBtn.onclick=async()=>{
  if(!chatWithId||!chatInput.value.trim()) return;
  await addDoc(collection(db,"chats",generateChatId(currentUser.uid,chatWithId),"messages"),{
    text:chatInput.value.trim(),
    sender:currentUser.uid,
    timestamp:new Date()
  });
  chatInput.value="";
};
</script>
</head>
<body>
<h1>Search & Add Friends</h1>
<div class="panel">
<div class="search-container">
<input type="text" id="searchInput" placeholder="UID or Name">
<button id="searchBtn">Search</button>
</div>
<div id="profileCard" class="profile-card"><p style="color:#0ff;">Search a user to add as friend</p></div>
</div>

<h1>Friend Requests</h1>
<div class="panel" id="reqContainer"></div>

<h1>Your Friends</h1>
<div class="panel friend-list" id="friendList"></div>

<div id="chatPanel">
<div id="chatHeader">Chat <span style="cursor:pointer;" onclick="chatPanel.style.display='none';chatWithId=null;">âœ–</span></div>
<div id="chatMessages"></div>
<div id="chatInputContainer">
<input type="text" id="chatInput" placeholder="Type a message...">
<button id="sendBtn">Send</button>
</div>
</div>
</body>
</html>

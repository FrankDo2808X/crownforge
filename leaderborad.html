<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CrownForge Leaderboard</title>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600&display=swap" rel="stylesheet">

<style>
body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  background: radial-gradient(circle at top, #2fd2c7, #1906a6, #1a1a1a);
  color: #fff;
  text-align: center;
  min-height: 100vh;
  overflow-x: hidden;
}

h1 {
  margin-top: 30px;
  text-shadow: 0 0 20px #1c1b18;
  font-size: 2em;
}

#leaderboard {
  margin: 30px auto;
  max-width: 400px;
  background: rgba(255, 165, 0, 0.1);
  border-radius: 15px;
  box-shadow: 0 0 20px rgba(255, 200, 0, 0.3);
  padding: 15px;
}

.player {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(255,255,255,0.1);
  border-radius: 10px;
  padding: 10px 15px;
  margin: 8px 0;
  transition: 0.3s;
}

.player:hover {
  background: rgba(255,255,255,0.2);
  transform: scale(1.02);
}

.rank {
  font-weight: 700;
  width: 25px;
}

.gold { color: gold; }
.silver { color: silver; }
.bronze { color: #cd7f32; }

.email {
  flex: 1;
  text-align: left;
  font-size: 0.9em;
  opacity: 0.9;
}

.eye-btn {
  cursor: pointer;
  margin-left: 5px;
  color: #ffcc33;
}

.time {
  font-weight: bold;
  color: #000000;
}

button {
  background: linear-gradient(90deg, #ffcc33, #ff6600);
  border: none;
  color: black;
  padding: 10px 20px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  margin: 20px;
  box-shadow: 0 0 10px #000000;
}

button:hover {
  box-shadow: 0 0 20px #ffaa00;
}

#userInfo {
  margin-top: 10px;
  font-size: 1em;
}
</style>
</head>
<body>

<h1>üî• CrownForge Leaderboard üî•</h1>
<p><b>NOTE:</b> Stay active for 7 days to win War-X rewards! Top 3 will get exclusive items.  
Enable notifications ‚Äî you‚Äôll get an official mail from CrownForge if you win.  
Never share OTP or private info!</p>

<button id="login">Login with Google</button>
<button id="logout" style="display:none;">Logout</button>
<div id="userInfo"></div>

<div id="leaderboard"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, onSnapshot, collection, query, orderBy } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

  // üî• Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDNy1J7zVJMLGLsyUxRT1EIaIBruI_p2G8",
    authDomain: "crownforgestudio-2581a.firebaseapp.com",
    projectId: "crownforgestudio-2581a",
    storageBucket: "crownforgestudio-2581a.appspot.com",
    messagingSenderId: "223324386293",
    appId: "1:223324386293:web:783a3e64f0d10b1ab026bc",
    measurementId: "G-EYRLR2CH35"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const loginBtn = document.getElementById("login");
  const logoutBtn = document.getElementById("logout");
  const userInfo = document.getElementById("userInfo");
  const leaderboardDiv = document.getElementById("leaderboard");
  const provider = new GoogleAuthProvider();

  let user = null;
  let timer = 0;
  let interval;
  const adminEmail = "abhigamer0338@gmail.com";

  // Function to mask email
  function maskEmail(email) {
    return email.replace(/(.{3})(.*)(@.*)/, "$1***$3");
  }

  // Login
  loginBtn.onclick = async () => {
    await signInWithPopup(auth, provider);
  };

  // Logout
  logoutBtn.onclick = async () => {
    clearInterval(interval);
    await signOut(auth);
  };

  // Auth listener
  onAuthStateChanged(auth, async (u) => {
    if (u) {
      user = u;
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";

      const shortEmail = maskEmail(u.email);
      userInfo.innerHTML = `<p>Logged in as: <strong>${shortEmail}</strong></p>`;

      // Start time counter
      interval = setInterval(async () => {
        timer++;
        await setDoc(doc(db, "leaderboard", u.uid), {
          email: u.email,
          time: timer
        });
      }, 1000);

      // Real-time leaderboard
      const q = query(collection(db, "leaderboard"), orderBy("time", "desc"));
      onSnapshot(q, (snapshot) => {
        leaderboardDiv.innerHTML = "";
        let rank = 1;

        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          let rankClass = "";
          if (rank === 1) rankClass = "gold";
          else if (rank === 2) rankClass = "silver";
          else if (rank === 3) rankClass = "bronze";

          const isSelf = (data.email === user.email);
          const isAdmin = (user.email === adminEmail);

          const displayEmail = isAdmin || isSelf ? data.email : maskEmail(data.email);

          leaderboardDiv.innerHTML += `
            <div class="player">
              <div class="rank ${rankClass}">#${rank}</div>
              <div class="email">
                ${displayEmail}
                ${isSelf && !isAdmin ? '<span class="eye-btn" data-email="' + data.email + '">üëÅÔ∏è</span>' : ''}
              </div>
              <div class="time">${data.time}s</div>
            </div>
          `;

          rank++;
          if (rank > 10) return;
        });

        // üëÅÔ∏è Toggle for user
        document.querySelectorAll(".eye-btn").forEach(btn => {
          btn.addEventListener("click", (e) => {
            const parent = e.target.parentElement;
            const email = e.target.dataset.email;
            if (parent.innerText.includes("***")) {
              parent.innerHTML = email + ' <span class="eye-btn" data-email="' + email + '">üôà</span>';
            } else {
              parent.innerHTML = maskEmail(email) + ' <span class="eye-btn" data-email="' + email + '">üëÅÔ∏è</span>';
            }
            document.querySelectorAll(".eye-btn").forEach(innerBtn => {
              innerBtn.addEventListener("click", (ev) => ev.target.click());
            });
          });
        });
      });

    } else {
      userInfo.innerHTML = "";
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
      leaderboardDiv.innerHTML = "";
    }
  });
</script>
</body>
</html>

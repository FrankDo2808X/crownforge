<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CrownForge Leaderboard</title>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600&display=swap" rel="stylesheet">

<style>
body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  background: radial-gradient(circle at top, #2fd2c7, #1906a6, #1a1a1a);
  color: #fff;
  text-align: center;
  min-height: 100vh;
  overflow-x: hidden;
}

h1 {
  margin-top: 30px;
  text-shadow: 0 0 20px #1c1b18;
  font-size: 2em;
}

#leaderboard {
  margin: 30px auto;
  max-width: 400px;
  background: rgba(255, 165, 0, 0.1);
  border-radius: 15px;
  box-shadow: 0 0 20px rgba(255, 200, 0, 0.3);
  padding: 15px;
}

.player {
  background: rgba(255,255,255,0.1);
  border-radius: 10px;
  padding: 10px 15px;
  margin: 8px 0;
  text-align: left;
  transition: 0.3s;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.player:hover {
  background: rgba(255,255,255,0.2);
  transform: scale(1.02);
}

.rank {
  font-weight: 700;
  font-size: 1.2em;
}

.gold { color: gold; }
.silver { color: silver; }
.bronze { color: #cd7f32; }

.name {
  font-size: 1.1em;
  font-weight: 600;
}

.email-small {
  font-size: 0.8em;
  opacity: 0.7;
  font-family: monospace;
}

.time {
  font-weight: bold;
  color: #000000;
  text-align: right;
  background: rgba(255,255,255,0.8);
  padding: 5px 10px;
  border-radius: 8px;
}

button {
  background: linear-gradient(90deg, #ffcc33, #ff6600);
  border: none;
  color: black;
  padding: 10px 20px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  margin: 10px;
  box-shadow: 0 0 10px #000000;
  transition: 0.2s;
}

button:hover {
  box-shadow: 0 0 20px #ffaa00;
}

#userInfo {
  margin-top: 10px;
  font-size: 1em;
}
</style>
</head>
<body>

<h1>ðŸ”¥ CrownForge Leaderboard ðŸ”¥</h1>
<p><b>NOTE:</b> Stay active for 7 days to win War-X rewards! Top 3 will get exclusive items.  
Enable notifications â€” youâ€™ll get an official mail from CrownForge if you win.  
Never share OTP or private info!</p>

<button id="login">Login with Google</button>
<button id="logout" style="display:none;">Logout</button>
<div id="userInfo"></div>

<div id="leaderboard"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, onSnapshot, collection, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

  // ðŸ”¥ Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDNy1J7zVJMLGLsyUxRT1EIaIBruI_p2G8",
    authDomain: "crownforgestudio-2581a.firebaseapp.com",
    projectId: "crownforgestudio-2581a",
    storageBucket: "crownforgestudio-2581a.appspot.com",
    messagingSenderId: "223324386293",
    appId: "1:223324386293:web:783a3e64f0d10b1ab026bc",
    measurementId: "G-EYRLR2CH35"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  const loginBtn = document.getElementById("login");
  const logoutBtn = document.getElementById("logout");
  const userInfo = document.getElementById("userInfo");
  const leaderboardDiv = document.getElementById("leaderboard");

  const adminEmail = "abhigamer0338@gmail.com";
  let user = null;
  let timer = 0;
  let interval;

  function getUserName(email) {
    return email.split("@")[0];
  }

  function hideEmail(email) {
    const [name, domain] = email.split("@");
    return name.slice(0, 3) + "***@" + domain;
  }

  function formatTime(seconds) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    if (h > 0) return `${h}h ${m}m ${s}s`;
    if (m > 0) return `${m}m ${s}s`;
    return `${s}s`;
  }

  loginBtn.onclick = async () => {
    await signInWithPopup(auth, provider);
  };

  logoutBtn.onclick = async () => {
    clearInterval(interval);
    await signOut(auth);
  };

  onAuthStateChanged(auth, async (u) => {
    if (u) {
      user = u;
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
      userInfo.innerHTML = `<p>Logged in as: <strong>${u.email}</strong></p>`;

      // Get saved time
      const docRef = doc(db, "leaderboard", u.uid);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        timer = docSnap.data().time || 0;
      }

      // Timer update (stable)
      interval = setInterval(async () => {
        timer++;
        await setDoc(doc(db, "leaderboard", u.uid), {
          email: u.email,
          time: timer
        });
      }, 1000);

      // Real-time leaderboard
      const q = query(collection(db, "leaderboard"), orderBy("time", "desc"));
      onSnapshot(q, (snapshot) => {
        leaderboardDiv.innerHTML = "";
        let rank = 1;
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const username = getUserName(data.email);
          let emailDisplay = u.email === adminEmail ? data.email : hideEmail(data.email);
          let rankClass = rank === 1 ? "gold" : rank === 2 ? "silver" : rank === 3 ? "bronze" : "";

          leaderboardDiv.innerHTML += `
            <div class="player">
              <div>
                <div class="rank ${rankClass}">#${rank}</div>
                <div class="name">${username}</div>
                <div class="email-small">${emailDisplay}</div>
              </div>
              <div class="time">${formatTime(data.time)}</div>
            </div>
          `;
          rank++;
        });
      });

    } else {
      userInfo.innerHTML = "";
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
      leaderboardDiv.innerHTML = "";
    }
  });
</script>
</body>
</html>
